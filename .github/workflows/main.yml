
name: Terraform-Vagrant-Ansible

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  terraform:
    name: Terraform & Vagrant
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v3   # ÙŠØ³Ø­Ø¨ Ø§Ù„Ø±ÙŠØ¨Ùˆ (main.tf + playbook.yml + Vagrantfile)

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7

      

      - name: Terraform Init
        run: C:\Terraform\terraform.exe init

      - name: Terraform Apply (run Vagrant)
        run: C:\Terraform\terraform.exe apply -auto-approve

      - name: Save inventory file
        run: |
          echo "[ubuntu]" > inventory.ini
          echo "127.0.0.1 ansible_user=vagrant ansible_ssh_private_key_file=$HOME/.vagrant.d/insecure_private_key ansible_ssh_extra_args='-o StrictHostKeyChecking=no'" >> inventory.ini
        shell: pwsh


  

      - name: Upload inventory artifact
        uses: actions/upload-artifact@v4
        with:
          name: inventory
          path: inventory.ini

    

  ansible:
   name: Configure K8s & Deploy Nginx
   needs: terraform
   runs-on: self-hosted
   steps:
     - uses: actions/checkout@v3

     - name: Download inventory
       uses: actions/download-artifact@v4
       with:
         name: inventory

     - name: Fix SSH key permissions in WSL
       run: |
          wsl --user root chmod 600 ~/.vagrant.d/insecure_private_key
       # wsl --user root chmod 600 /mnt/c/Users/HOUSSAM/Desktop/terraform-ansible-vbox/.vagrant/machines/default/virtualbox/private_key
       # wsl --user root chown $(id -u):$(id -g) ~/.vagrant.d/insecure_private_key
       shell: pwsh

     - name: Remove old SSH host key
       run: |
         wsl --user root ssh-keygen -f "/root/.ssh/known_hosts" -R "192.168.56.10"
       shell: pwsh

    # ðŸ‘‡ NEW: Setup venv and install Ansible + k8s SDK
     - name: Setup Ansible Virtual Environment
       run: |
         wsl << 'EOF'
         # Create or recreate venv
         rm -rf ~/ansible-env
         python3 -m venv ~/ansible-env
         source ~/ansible-env/bin/activate
         pip install --upgrade pip
         pip install ansible kubernetes

         echo "âœ… Ansible environment ready"
         EOF
       shell: pwsh

    # ðŸ‘‡ Run playbook INSIDE the venv
     - name: Run Ansible Playbook
       run: |
         wsl << 'EOF'
         source ~/ansible-env/bin/activate
         ansible-playbook \
           -i /mnt/c/Users/HOUSSAM/Desktop/terraform-ansible-vbox/inventory.ini \
           /mnt/c/Users/HOUSSAM/Desktop/terraform-ansible-vbox/playbook.yml
         EOF
       shell: pwsh
